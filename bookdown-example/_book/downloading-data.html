<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 2 Downloading data | RAP Workshop</title>
<meta name="author" content="Data Science Team">
<meta name="description" content="This page will take you through the steps for downloading data from a URL specified within a config file, and catching/logging any errors encountered. We will perform the following steps: download...">
<meta name="generator" content="bookdown 0.35 with bs4_book()">
<meta property="og:title" content="Chapter 2 Downloading data | RAP Workshop">
<meta property="og:type" content="book">
<meta property="og:description" content="This page will take you through the steps for downloading data from a URL specified within a config file, and catching/logging any errors encountered. We will perform the following steps: download...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 2 Downloading data | RAP Workshop">
<meta name="twitter:description" content="This page will take you through the steps for downloading data from a URL specified within a config file, and catching/logging any errors encountered. We will perform the following steps: download...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">RAP Workshop</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> RAP Workshop</a></li>
<li><a class="active" href="downloading-data.html"><span class="header-section-number">2</span> Downloading data</a></li>
<li><a class="" href="exercise.html"><span class="header-section-number">3</span> Exercise</a></li>
<li><a class="" href="exercise-solution.html"><span class="header-section-number">4</span> Exercise solution</a></li>
<li><a class="" href="plotting-and-calculating-summary-statistics.html"><span class="header-section-number">5</span> Plotting and calculating summary statistics</a></li>
<li><a class="" href="exercise-1.html"><span class="header-section-number">6</span> Exercise</a></li>
<li><a class="" href="exercise-solution-1.html"><span class="header-section-number">7</span> Exercise solution</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/rstudio/bookdown-demo">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="downloading-data" class="section level1" number="2">
<h1>
<span class="header-section-number">2</span> Downloading data<a class="anchor" aria-label="anchor" href="#downloading-data"><i class="fas fa-link"></i></a>
</h1>
<p>This page will take you through the steps for downloading data from a URL specified within a config file, and catching/logging any errors encountered. We will perform the following steps:</p>
<ul>
<li>download meta data describing what ONS data is available</li>
<li>download meta data to get the URL for the latest release of your chosen ONS data</li>
<li>download the latest release file.</li>
</ul>
<p>We will then extract some summary statistics and print them to the console.</p>
<div id="data-setup-and-load-ons-meta-data" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Data setup and load ONS meta data<a class="anchor" aria-label="anchor" href="#data-setup-and-load-ons-meta-data"><i class="fas fa-link"></i></a>
</h2>
<p>We start by reading in required libraries:</p>
<pre><code><a href="https://tidyverse.tidyverse.org">library(tidyverse)
library(httr)
library(dplyr)
library(jsonlite)</a></code></pre>
<p>It is good practice to define parameters needed by your code in configuration files, because that means you don’t have to touch the code when you need to change any parameter values.</p>
<p>In the DHSC Template, the main configuration file sits in the ./input directory and is called config.yml.</p>
<p>The config file for this exercise contains the following parameter/settings:</p>
<pre><code>data_dictionary_url: "https://api.beta.ons.gov.uk/v1/datasets"
data_id: "regional-gdp-by-year"
input_dir: ./input
output_dir: ./output</code></pre>
<p>The first step, having made desired changes to the parameter values, is to load the contents of the config.yml file. This is done as follows:</p>
<pre><code># read in configuration
config_path &lt;- file.path("input", "config.yml")
config &lt;- yaml::read_yaml(config_path)

# print the config file details
print(config)</code></pre>
<p>It should be noted that reading the config file is normally done in the top level main function, which then passes a reference to the file to any functions that need it. But in this instance we have loaded the config file ourselves, to illustrate how this can be done.</p>
</div>
<div id="get-a-list-of-data-that-can-be-extracted-using-this-ons-api" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> Get a list of data that can be extracted using this ONS API<a class="anchor" aria-label="anchor" href="#get-a-list-of-data-that-can-be-extracted-using-this-ons-api"><i class="fas fa-link"></i></a>
</h2>
<p>We pass the data_dictionary_url to a GET function to download a list of available data, and we then wrangle it before writing it to a .csv.</p>
<div id="error-processing" class="section level3" number="2.2.1">
<h3>
<span class="header-section-number">2.2.1</span> error processing<a class="anchor" aria-label="anchor" href="#error-processing"><i class="fas fa-link"></i></a>
</h3>
<p>We use tryCatch({ … }) to capture any errors reading the URL (or for reading any other files or other Input/Output). If we did not have a tryCatch block, on encountering an error, the code automatically stops executing and passes the error to the function that called it. This carries on up the chain of calling functions until the error is either captured by a tryCatch block or the whole program fails, and the error is written to the console. By using tryCatch({…}) can intercept this process, and have more fine grained control over how we deal with the error:</p>
<ul>
<li>we can add addition information to the error message to help users narrow down where the problem lies</li>
<li>we can choose to carry on executing the code if the error isn’t catastrophic.</li>
</ul>
<p>Normal usage is to wrap the call to get any I/O in the tryCatch {} block and then deal with the error in the error function. In this case we just print the message to the console but in later exercises you will see how error messages can be written to the output log.</p>
<pre><code>  path &lt;- config$data_dictionary_url

  ret_code &lt;- -1
  tryCatch(
    {
      request &lt;- GET(url = path) # see httr for more detail on this function
      ret_code &lt;- 0
      },
    error = function(e){
      print(e)
      message(e)
      }
    )

  #check if an error reading, and if so return to calling function
  if(ret_code &lt; 0) return(NULL)

  content &lt;- rawToChar(request$content)
  content_flat &lt;- fromJSON(content, flatten = TRUE) # use this jsonlite function to convert JSON data to an R object
  
  # create a dataframe with the downloaded data dictionary and save to csv
  # so I can see what data is available
  df &lt;- data.frame(id = content_flat$items$id,
                   title = content_flat$items$title,
                   release_frequency = content_flat$items$release_frequency,
                   next_release = content_flat$items$next_release,
                   description = content_flat$items$description,
                   links_latest_versions = content_flat$items$links.latest_version.href,
                   links_self_href= content_flat$items$links.self.href,
                   qmi_href= content_flat$items$qmi.href)
                   
  print(df)

  # now write the data to an output file so you can check the data dictionary offline. Note how the 
  # output directory is a parameter in the config file.
  write.csv(df,
            paste0(config$output_dir, "/ons_api.csv"))</code></pre>
<p>The data dictionary contents are shown below</p>
<div class="figure">
<img src="ons_api.jpg" alt=""><p class="caption">data dictionary</p>
</div>
</div>
</div>
<div id="get-the-url-for-the-latest-release-of-a-specified-ons-file" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Get the URL for the latest release of a specified ONS file<a class="anchor" aria-label="anchor" href="#get-the-url-for-the-latest-release-of-a-specified-ons-file"><i class="fas fa-link"></i></a>
</h2>
<p>ONS data files have a unique identifier and this can be used to extract the data. The id we are interested in is specified in the config file and so use that to interrogate the data dictionary. In particular, we want to extract the latest version, the url for which can be extracted from the data dictionary -&gt; links_latest_versions field</p>
<pre><code>file_latest_version &lt;- df %&gt;%
    filter(id == config$data_id) %&gt;%
    select(links_latest_versions) %&gt;%
    pull()

  # Using the links_latest_versions we can get the meta data for the latest file
  # and this meta data includes the url for the latest file in either csv or xlsx
  # format. We choose .csv here -&gt; extract it from downloads$csv$href

  ret_code &lt;- -1
  tryCatch(
    {
      request &lt;- GET(url = file_latest_version)
      ret_code &lt;- 0
    },
    error = function(e){
      print(e)
      message(e)
    }
  )

  #check if an error reading, and if so return to calling function
  if(ret_code &lt; 0) return(NULL)

  content &lt;- rawToChar(request$content)
  content_flat &lt;- fromJSON(content, flatten=TRUE)
  file_url &lt;- content_flat$downloads$csv$href</code></pre>
</div>
<div id="now-we-have-the-file-url-we-can-read-it-like-any-other-file" class="section level2" number="2.4">
<h2>
<span class="header-section-number">2.4</span> Now we have the file url we can read it like any other file<a class="anchor" aria-label="anchor" href="#now-we-have-the-file-url-we-can-read-it-like-any-other-file"><i class="fas fa-link"></i></a>
</h2>
<pre><code>ret_code &lt;- -1
  tryCatch(
    {
      df_data &lt;- read.csv(file_url)
      ret_code &lt;- 0
    },
    error = function(e){
      print(e)
      message(e)
    }
  )

  #check if an error reading, and if so return to calling function
  if(ret_code &lt; 0) return(NULL)

  write.csv(df_data,
            paste0(config$output_dir,
                   "/",
                   config$data_id,
                   ".csv")
  )</code></pre>
</div>
<div id="print-summary-stats-and-finish" class="section level2" number="2.5">
<h2>
<span class="header-section-number">2.5</span> Print summary stats and finish<a class="anchor" aria-label="anchor" href="#print-summary-stats-and-finish"><i class="fas fa-link"></i></a>
</h2>
<p>Note that the return statement has been commented out, but in normal circumstances we would return the file contents as a dataframe.</p>
<pre><code> rowcount &lt;- nrow(df_data)
  log_message &lt;- sprintf("Number of rows downloaded for %s was: %d",
                         config$data_id,
                         rowcount)

  print(log_message)
  # return(df_data) </code></pre>
<p>In the next section, you’ll practice these techniques using a different ONS dataset.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="index.html"><span class="header-section-number">1</span> RAP Workshop</a></div>
<div class="next"><a href="exercise.html"><span class="header-section-number">3</span> Exercise</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#downloading-data"><span class="header-section-number">2</span> Downloading data</a></li>
<li><a class="nav-link" href="#data-setup-and-load-ons-meta-data"><span class="header-section-number">2.1</span> Data setup and load ONS meta data</a></li>
<li>
<a class="nav-link" href="#get-a-list-of-data-that-can-be-extracted-using-this-ons-api"><span class="header-section-number">2.2</span> Get a list of data that can be extracted using this ONS API</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#error-processing"><span class="header-section-number">2.2.1</span> error processing</a></li></ul>
</li>
<li><a class="nav-link" href="#get-the-url-for-the-latest-release-of-a-specified-ons-file"><span class="header-section-number">2.3</span> Get the URL for the latest release of a specified ONS file</a></li>
<li><a class="nav-link" href="#now-we-have-the-file-url-we-can-read-it-like-any-other-file"><span class="header-section-number">2.4</span> Now we have the file url we can read it like any other file</a></li>
<li><a class="nav-link" href="#print-summary-stats-and-finish"><span class="header-section-number">2.5</span> Print summary stats and finish</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/rstudio/bookdown-demo/blob/master/01-download-data-summary.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/rstudio/bookdown-demo/edit/master/01-download-data-summary.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>RAP Workshop</strong>" was written by Data Science Team. It was last built on 2023-09-18.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
